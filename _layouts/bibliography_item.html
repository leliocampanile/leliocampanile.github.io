{%- comment -%} URL robusto alla pagina details (rispetta details_permalink/permalink globali) {%- endcomment -%}
{%- capture detail_url -%}{% details_link entry.key %}{%- endcapture -%}

{%- comment -%} Badge: prova dal type, poi fallback journal/booktitle {%- endcomment -%}
{%- assign raw_kind = e.type | default: '' | downcase | strip -%}
{%- assign pub_badge = nil -%}
{%- if raw_kind contains 'article' -%}{% assign pub_badge = 'Journal' %}
{%- elsif raw_kind contains 'conference' -%}{% assign pub_badge = 'Conference' %}
{%- elsif raw_kind contains 'book chapter' -%}{% assign pub_badge = 'Book Chapter' %}
{%- else %}{% assign pub_badge = 'Other' %}
{%- endif -%}
{%- if pub_badge == nil -%}
  {%- if e.journal %}{% assign pub_badge = 'Journal' %}
  {%- elsif e.booktitle %}{% assign pub_badge = 'Conference' %}
  {%- else %}{% assign pub_badge = 'Other' %}{% endif -%}
{%- endif -%}
{%- assign pub_class = pub_badge | downcase | replace: ' ', '-' -%}


<div class="pub-item">
  <span class="pub-badge pub-badge-{{ pub_class }}">{{ pub_badge }}</span>
  <!-- Titolo linkato alla pagina di dettaglio -->
  <div class="pub-title">
    <a href="{{ detail_url }}">{{ entry.title }}</a>
  </div>

  <!-- Citazione completa formattata da CSL -->
  <div class="citation">{{ reference }}</div>

  <!-- Abstract a scomparsa (se presente nel .bib) -->
  {% if entry.abstract %}
  <details class="pub-abstract">
    <summary>Abstract</summary>
    <div class="abstract-body">
      {{ entry.abstract }}
    </div>
  </details>
  {% endif %}

  <!-- Azioni: DOI/URL + Details + Copy/Download BibTeX -->
  <div class="pub-actions">
    {% if entry.doi %}
      <a class="btn btn-pub" href="https://doi.org/{{ entry.doi }}" target="_blank" rel="noopener">DOI</a>
    {% endif %}
    {% if entry.url %}
      <a class="btn btn-pub" href="{{ entry.url }}" target="_blank" rel="noopener">Publisher</a>
    {% endif %}

    <!-- Link esplicito ai details -->
    <a class="btn btn-pub" href="{{ detail_url }}">Details</a>

    <button class="btn btn-pub copy-bib" data-key="{{ entry.key }}">Copy BibTeX</button>
    <button class="btn btn-pub download-bib" data-key="{{ entry.key }}">Download .bib</button>

    <!-- BibTeX grezzo nascosto (per copy/download) -->
<pre id="bib-{{ entry.key }}" class="bibtex" style="display:none">
{% include bibtex_minimal.html entry=entry %}
</pre>
  </div>
</div>
